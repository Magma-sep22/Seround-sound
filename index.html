<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Noise Pollution Monitor</title>
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: #f5f7fa;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    h1 {
      font-size: 1.8rem;
      font-weight: 700;
      color: #007acc;
      margin-bottom: 10px;
    }
    #dbValue {
      font-size: 4rem;
      font-weight: 800;
      margin: 10px 0;
    }
    #status {
      font-size: 1.4rem;
      font-weight: 600;
      padding: 6px 18px;
      border-radius: 12px;
      margin-bottom: 15px;
    }
    .safe { background:#c6f6d5; color:#22543d; }
    .warning { background:#fefcbf; color:#744210; }
    .danger { background:#fed7d7; color:#742a2a; }

    .controls button {
      padding: 10px 16px;
      margin: 6px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
    }
    .start { background:#38b2ac; color:white; }
    .stop { background:#f56565; color:white; }
    .reset { background:#718096; color:white; }

    #graph {
      width: 90%;
      height: 150px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-top: 20px;
    }
  </style>
</head>
<body>

  <h1>Realtime Noise Pollution Monitor</h1>
  <div id="dbValue">-- dB</div>
  <div id="status" class="safe">กำลังตรวจวัด...</div>

  <div class="controls">
    <button class="start" onclick="startMeasure()">เริ่มวัดเสียง</button>
    <button class="stop" onclick="stopMeasure()">หยุด</button>
    <button class="reset" onclick="resetMeasure()">รีเซ็ต</button>
  </div>

  <canvas id="graph"></canvas>

  <script>
    let audioContext, analyser, dataArray, source;
    let rafId;

    const dbValue = document.getElementById("dbValue");
    const statusBox = document.getElementById("status");
    const canvas = document.getElementById("graph");
    const ctx = canvas.getContext("2d");

    function updateStatus(db) {
      if (db < 50) {
        statusBox.textContent = "ปลอดภัย";
        statusBox.className = "safe";
      } else if (db < 80) {
        statusBox.textContent = "ควรระวัง";
        statusBox.className = "warning";
      } else {
        statusBox.textContent = "อันตราย!";
        statusBox.className = "danger";
      }
    }

    function drawGraph(db) {
      ctx.fillStyle = "#fff";
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = db < 50 ? "#48bb78" : db < 80 ? "#ecc94b" : "#f56565";
      let barHeight = (db/120) * canvas.height;
      ctx.fillRect(20, canvas.height - barHeight, canvas.width-40, barHeight);
    }

    function startMeasure() {
      navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
        audioContext = new AudioContext();
        source = audioContext.createMediaStreamSource(stream);
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 512;
        dataArray = new Uint8Array(analyser.frequencyBinCount);
        source.connect(analyser);
        loop();
      });
    }

    function stopMeasure() {
      if (audioContext) audioContext.close();
      cancelAnimationFrame(rafId);
      dbValue.textContent = "-- dB";
      statusBox.textContent = "หยุดการตรวจวัด";
      statusBox.className = "reset";
    }

    function resetMeasure() {
      dbValue.textContent = "-- dB";
      statusBox.textContent = "รีเซ็ตเรียบร้อย";
      statusBox.className = "safe";
      ctx.clearRect(0,0,canvas.width,canvas.height);
    }

    function loop() {
      rafId = requestAnimationFrame(loop);
      analyser.getByteFrequencyData(dataArray);
      let values = 0;
      for (let i = 0; i < dataArray.length; i++) {
        values += dataArray[i];
      }
      let average = values / dataArray.length;
      let db = Math.round((average/255)*120); // Normalize to 0–120 dB scale
      dbValue.textContent = db + " dB";
      updateStatus(db);
      drawGraph(db);
    }
  </script>
</body>
</html>
