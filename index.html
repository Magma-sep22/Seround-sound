<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Realtime Sound Pollution Monitor (iOS Safe)</title>
  <style>
    body {
      margin: 0;
      background: linear-gradient(to bottom right, #e3f2fd, #ffffff);
      font: 14px/1.6 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color: #111;
      display: grid;
      place-items: center;
      min-height: 100vh;
    }

    .card {
      width: min(720px, 94vw);
      background: rgba(255, 255, 255, 0.7); /* พื้นหลังโปร่งใส */
      border: 1px solid #e0e0e0;
      border-radius: 16px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1);
      padding: 20px;
      display: grid;
      gap: 12px;
      backdrop-filter: blur(8px); /* เบลอพื้นหลัง */
    }

    h1 {
      margin: 0 0 8px;
      font-size: 20px;
      text-align: center;
      color: #1565c0;
    }

    #db {
      font-size: clamp(28px, 8vw, 50px);
      font-weight: bold;
      text-align: center;
    }

    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
    }

    .badge {
      padding: 4px 10px;
      font-size: 13px;
      border-radius: 999px;
      font-weight: 600;
      border: 1px solid;
    }

    .safe {
      color: #2e7d32;
      background: #e8f5e9;
      border-color: #c8e6c9;
    }

    .danger {
      color: #c62828;
      background: #ffebee;
      border-color: #ef9a9a;
    }

    button {
      padding: 8px 12px;
      font-size: 13px;
      border-radius: 8px;
      border: 1px solid #ccc;
      background: #fff;
      cursor: pointer;
      font-weight: 600;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    #msg {
      color: red;
      text-align: center;
      font-size: 13px;
    }

    small {
      text-align: center;
      display: block;
      font-size: 12px;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Realtime Sound Pollution Monitor</h1>
    <div id="db">-- dB --</div>

    <div class="row">
      <span id="status" class="badge safe">ปลอดภัย</span>
      <span id="time" class="badge" style="border-color:#ccc;background:#f8f9fa;color:#333">
        เวลาสะสมในโซนอันตราย: 00:00
      </span>
    </div>

    <div class="row">
      <button id="start">เริ่มวัดเสียง</button>
      <button id="stop" disabled>หยุด</button>
      <button id="reset">รีเซ็ตเวลา</button>
    </div>

    <p id="msg"></p>
    <small>ถ้าไม่ขึ้นหน้าต่างขอสิทธิ์ไมค์: Settings → Safari → Advanced → Website Data → clear</small>
  </div>

  <script>
    (() => {
      const threshold = -45; // ปรับตามความเหมาะสม
      const dbEl = document.getElementById('db');
      const statusEl = document.getElementById('status');
      const timeEl = document.getElementById('time');
      const startBtn = document.getElementById('start');
      const stopBtn = document.getElementById('stop');
      const resetBtn = document.getElementById('reset');
      const msgEl = document.getElementById('msg');

      let audioCtx, analyser, source, stream;
      let rafId = null;
      let running = false;

      let inDanger = false;
      let dangerAccumMs = 0;
      let lastDangerStart = null;

      const fmt = (ms) => {
        const sec = Math.floor(ms / 1000);
        const m = Math.floor(sec / 60);
        const s = sec % 60;
        return String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
      };

      function updateDanger(now, db) {
        if (db > threshold) {
          if (!inDanger) {
            inDanger = true;
            lastDangerStart = now;
            statusEl.textContent = 'อันตราย';
            statusEl.className = 'badge danger';
          } else {
            dangerAccumMs += now - lastDangerStart;
            lastDangerStart = now;
          }
        } else {
          if (inDanger) {
            dangerAccumMs += now - lastDangerStart;
          }
          inDanger = false;
          statusEl.textContent = 'ปลอดภัย';
          statusEl.className = 'badge safe';
        }
        timeEl.textContent = 'เวลาสะสมในโซนอันตราย: ' + fmt(dangerAccumMs);
      }

      function loop() {
        if (!running) return;
        const N = 1024;
        const arr = new Float32Array(N);
        analyser.getFloatTimeDomainData(arr);

        let sum = 0;
        for (let i = 0; i < N; i++) sum += arr[i] * arr[i];
        const rms = Math.sqrt(sum / N);
        const db = rms > 0 ? 20 * Math.log10(rms) : -90;

        dbEl.textContent = db.toFixed(1) + ' dB';
        updateDanger(performance.now(), db);

        rafId = requestAnimationFrame(loop);
      }

      async function ensureResumed() {
        try {
          if (audioCtx && audioCtx.state === 'suspended') {
            await audioCtx.resume();
          }
        } catch {}
      }

      async function start() {
        msgEl.textContent = '';
        try {
          if (location.protocol !== 'https:') {
            msgEl.textContent = 'ต้องใช้ผ่าน HTTPS';
            return;
          }

          stream = await navigator.mediaDevices.getUserMedia({
            audio: {
              echoCancellation: false,
              noiseSuppression: false,
              autoGainControl: false
            }
          });

          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          await ensureResumed();

          analyser = audioCtx.createAnalyser();
          analyser.fftSize = 2048;

          source = audioCtx.createMediaStreamSource(stream);
          source.connect(analyser);

          running = true;
          startBtn.disabled = true;
          stopBtn.disabled = false;

          loop();
        } catch (err) {
          msgEl.textContent = '❌ ใช้ไมโครโฟนไม่ได้: ' + (err.message || err.name);
        }
      }

      function stop() {
        running = false;
        if (rafId) cancelAnimationFrame(rafId);
        if (source) try { source.disconnect(); } catch {}
        if (analyser) try { analyser.disconnect?.(); } catch {}
        if (stream) stream.getTracks().forEach(t => t.stop());
        if (audioCtx) try { audioCtx.close(); } catch {}
        audioCtx = analyser = source = stream = null;
        startBtn.disabled = false;
        stopBtn.disabled = true;
      }

      startBtn.addEventListener('click', start);
      stopBtn.addEventListener('click', stop);
      resetBtn.addEventListener('click', () => {
        dangerAccumMs = 0;
        if (inDanger) lastDangerStart = performance.now();
        timeEl.textContent = 'เวลาสะสมในโซนอันตราย: ' + fmt(dangerAccumMs);
      });

      document.addEventListener('visibilitychange', ensureResumed);
      window.addEventListener('touchstart', ensureResumed, { passive: true });
    })();
  </script>
</body>
</html>
